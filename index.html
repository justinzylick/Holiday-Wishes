<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Happy Holidays!</title>

  <style>
    @import url('https://fonts.cdnfonts.com/css/futura-md-bt');

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      min-height: 100vh;
      background: linear-gradient(to bottom, #0d1b2a, #1b263b, #415a77);
      display: flex;
      align-items: flex-start;
      padding-top: 20vh;
      justify-content: center;
      font-family: Georgia, serif;
      overflow: hidden;
    }

    .message {
      text-align: center;
      color: #fff;
      z-index: 10;
      animation: fadeIn 2s ease-in;
      max-width: 700px;
      padding: 0 2rem;
    }
    .message h1 {
      font-size: 3rem;
      margin-bottom: 1.5rem;
      text-shadow: 0 0 20px rgba(255,255,255,0.3);
    }
    .message p {
      font-size: 1.3rem;
      opacity: 0.95;
      line-height: 1.6;
    }
    .message .healthy-new-year { margin-top: 0.8rem; }
    .message .subtext {
      margin-top: 1.2rem;
      font-size: 1rem;
      opacity: 0.75;
      font-style: italic;
    }
    .message .moon-line { display: block; margin-top: 0.3rem; }

    /* Music Toggle Button */
    .music-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
      border: 2px solid rgba(255,255,255,0.3);
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 110;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      -webkit-tap-highlight-color: transparent;
    }
    .music-toggle:hover {
      background: rgba(255,255,255,0.25);
      transform: scale(1.1);
    }
    .music-toggle.playing {
      background: rgba(212, 175, 55, 0.3);
      border-color: rgba(212, 175, 55, 0.6);
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
    }

    /* One-time audio unlock overlay (mobile/iOS reliability) */
    .audio-unlock {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 22px;
      backdrop-filter: blur(6px);
    }
    .audio-unlock.show { display: flex; }
    .audio-unlock-card {
      width: min(560px, 92vw);
      background: linear-gradient(135deg, rgba(255,255,255,0.10), rgba(255,255,255,0.05));
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 18px;
      padding: 18px 18px;
      color: #fff;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.55);
    }
    .audio-unlock-card h2 {
      font-size: 1.35rem;
      margin-bottom: 8px;
    }
    .audio-unlock-card p {
      font-size: 1rem;
      opacity: 0.9;
      line-height: 1.4;
      margin-bottom: 14px;
    }
    .audio-unlock-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 999px;
      border: 1px solid rgba(212,175,55,0.55);
      background: rgba(212,175,55,0.20);
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      -webkit-tap-highlight-color: transparent;
    }
    .audio-unlock-btn:active { transform: scale(0.98); }
    .audio-unlock-note {
      margin-top: 10px;
      font-size: 0.9rem;
      opacity: 0.75;
      font-style: italic;
    }

    /* Optional hint bubble */
    .audio-hint {
      position: fixed;
      top: 80px;
      left: 20px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.18);
      color: rgba(255,255,255,0.92);
      font-size: 0.9rem;
      z-index: 105;
      backdrop-filter: blur(6px);
      opacity: 0;
      transform: translateY(-6px);
      transition: opacity 0.25s ease, transform 0.25s ease;
      pointer-events: none;
      max-width: 260px;
      line-height: 1.3;
    }
    .audio-hint.show { opacity: 1; transform: translateY(0); }

    .bitcoin-moon {
      position: fixed;
      top: 8%;
      right: 12%;
      width: 130px;
      height: 130px;
      background: radial-gradient(circle at 30% 30%, #f7931a, #c27214);
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #fff;
      box-shadow:
        0 0 60px rgba(247, 147, 26, 0.6),
        0 0 120px rgba(247, 147, 26, 0.3);
      animation: glow 3s ease-in-out infinite alternate, rise 3s ease-out;
      z-index: 5;
      cursor: pointer;
      text-decoration: none;
      transition: transform 0.2s ease;
    }
    .bitcoin-moon:hover { transform: scale(1.05); }
    .bitcoin-moon .btc-symbol {
      font-size: 2.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .bitcoin-moon .btc-price {
      font-size: 0.85rem;
      margin-top: 0.2rem;
      text-shadow: 0 1px 2px rgba(0,0,0,0.4);
      opacity: 0.95;
    }

    .santa-container {
      position: fixed;
      top: 50%;
      animation: fly 12s linear infinite;
      z-index: 20;
      white-space: nowrap;
      transform: rotate(-15deg);
      
      /* CHANGED LINES BELOW: */
      pointer-events: auto;     /* Allows clicking */
      cursor: pointer;          /* Shows hand icon */
      text-decoration: none;    /* Removes underline */
    }
    .santa {
      font-size: 2.2rem;
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
      display: inline-block;
    }
    .reindeer { display: inline-block; transform: scaleX(-1); }

    .star {
      position: fixed;
      background: #fff;
      border-radius: 50%;
      animation: twinkle ease-in-out infinite;
      pointer-events: none;
    }
    .snowflake {
      position: fixed;
      top: -10px;
      color: #fff;
      font-size: 1.5rem;
      animation: fall linear infinite;
      opacity: 0.8;
      z-index: 25;
      pointer-events: none;
    }

    /* Bottom section */
    .bottom-section {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 15;
    }
    .diageo-logo {
      cursor: pointer;
      transition: transform 0.2s ease;
      font-family: 'Futura Md BT', 'Futura', 'Century Gothic', sans-serif;
      font-size: 2.2rem;
      font-weight: 500;
      color: #C80651;
      letter-spacing: 6px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      -webkit-tap-highlight-color: transparent;
    }
    .diageo-logo:hover { transform: scale(1.05); }
    .signoff {
      margin-top: 15px;
      color: #fff;
      font-size: 1.1rem;
      font-style: italic;
      opacity: 0.9;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    .signoff-initials { cursor: pointer; transition: color 0.2s ease; -webkit-tap-highlight-color: transparent; }
    .signoff-initials:hover { color: #d4af37; }

    /* Modals */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 100;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
      padding: 18px;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 16px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      color: #fff;
      position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      -webkit-overflow-scrolling: touch;
    }
    .modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .modal-close:hover { opacity: 1; }
    .modal h2 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      color: #d4af37;
      text-align: center;
    }
    .modal h3 {
      font-size: 1.1rem;
      margin-top: 1.2rem;
      margin-bottom: 0.5rem;
      color: #d4af37;
    }
    .modal ul { list-style: none; padding-left: 0; }
    .modal ul li {
      padding: 0.3rem 0;
      padding-left: 1.5rem;
      position: relative;
      font-size: 0.95rem;
      opacity: 0.9;
    }
    .modal ul li:before {
      content: "‚Ä¢";
      color: #d4af37;
      position: absolute;
      left: 0;
    }
    .modal ol { padding-left: 1.5rem; }
    .modal ol li {
      padding: 0.4rem 0;
      font-size: 0.95rem;
      opacity: 0.9;
    }
    .modal ol li strong { color: #d4af37; }
    .modal .tip {
      margin-top: 1.2rem;
      padding: 0.8rem;
      background: rgba(212, 175, 55, 0.1);
      border-radius: 8px;
      font-size: 0.9rem;
      font-style: italic;
      opacity: 0.85;
    }

    /* Chocolate martini (SVG) */
    .martini-wrap{
      display:flex;
      justify-content:center;
      margin-bottom: 1rem;
    }
    .martini-svg{
      width: 110px;
      height: auto;
      filter: drop-shadow(0 12px 28px rgba(0,0,0,0.45));
    }
    .martini-svg .glass{ stroke: rgba(255,255,255,0.9); }
    .martini-svg .foam{ fill: rgba(255,255,255,0.18); }
    .martini-svg .dust{ fill: rgba(255,255,255,0.55); opacity: 0.45; }

    @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes glow {
      from { box-shadow: 0 0 60px rgba(247, 147, 26, 0.6), 0 0 120px rgba(247, 147, 26, 0.3); }
      to { box-shadow: 0 0 80px rgba(247, 147, 26, 0.8), 0 0 160px rgba(247, 147, 26, 0.5); }
    }
    @keyframes rise { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }
    @keyframes fly { from { left: -350px; top: 50%; } to { left: 110vw; top: -15%; } }

    /* Mobile polish (does NOT affect desktop look) */
    :root {
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
    }

    @media (max-width: 600px) {
      body {
        padding: calc(14px + var(--safe-top)) calc(14px + var(--safe-right))
                 calc(14px + var(--safe-bottom)) calc(14px + var(--safe-left));
      }

      .message { max-width: 92vw; padding: 0 0.75rem; }
      .message h1 { font-size: clamp(1.9rem, 5.5vw, 2.4rem); margin-bottom: 1rem; }
      .message p { font-size: clamp(1.02rem, 3.6vw, 1.15rem); line-height: 1.5; }
      .message .subtext { font-size: clamp(0.9rem, 3.2vw, 1.0rem); margin-top: 0.9rem; }

      .bitcoin-moon {
        top: calc(10px + var(--safe-top));
        right: calc(10px + var(--safe-right));
        width: 92px; height: 92px;
      }
      .bitcoin-moon .btc-symbol { font-size: 2.0rem; }
      .bitcoin-moon .btc-price { font-size: 0.72rem; }

      .music-toggle {
        top: calc(12px + var(--safe-top));
        left: calc(12px + var(--safe-left));
        width: 48px; height: 48px;
      }
      .audio-hint {
        top: calc(72px + var(--safe-top));
        left: calc(12px + var(--safe-left));
      }

      .bottom-section { bottom: calc(16px + var(--safe-bottom)); }
      .diageo-logo { font-size: 1.75rem; letter-spacing: 4px; }
      .signoff { font-size: 1rem; }
      .santa { font-size: 1.85rem; }

      .modal { width: min(92vw, 520px); padding: 1.25rem; border-radius: 14px; }
      .modal h2 { font-size: 1.55rem; }
      .modal ul li, .modal ol li { font-size: 0.95rem; }

      .snowflake { opacity: 0.65; }
    }

    @media (max-width: 380px) {
      .bitcoin-moon { width: 82px; height: 82px; }
      .diageo-logo { font-size: 1.6rem; letter-spacing: 3px; }
      .message h1 { font-size: 1.85rem; }
    }

    @media (prefers-reduced-motion: reduce) {
      .star, .snowflake, .santa-container, .bitcoin-moon, .message {
        animation: none !important;
      }
    }
  </style>
</head>

<body>
  <div class="audio-unlock" id="audioUnlock">
    <div class="audio-unlock-card">
      <h2>Turn sound on üé∂</h2>
      <p>Tap once to enable the music, then use the speaker button anytime.</p>
      <button class="audio-unlock-btn" id="audioUnlockBtn" type="button">Enable Sound</button>
      <div class="audio-unlock-note">iPhone tip: if it‚Äôs still silent, flip your Silent switch off.</div>
    </div>
  </div>

  <button class="music-toggle" id="musicToggle" onclick="toggleMusic()" title="Tap for Jingle Bells!" aria-label="Toggle music">üîá</button>
  <div class="audio-hint" id="audioHint">If sound is blocked, tap Enable Sound, then tap the speaker üé∂</div>

  <a href="https://coinmarketcap.com/charts/fear-and-greed-index/" target="_blank" class="bitcoin-moon" rel="noopener">
    <span class="btc-symbol">‚Çø</span>
    <span class="btc-price" id="price">$93,500</span>
  </a>

<a href="https://www.noradsanta.org/en/map" target="_blank" class="santa-container" aria-label="Track Santa Live">
    <span class="santa">üéÖüõ∑<span class="reindeer">ü¶åü¶åü¶åü¶åü¶åü¶åü¶åü¶å</span></span>
  </a>

  <div class="message">
    <h1>‚ú® Happy Holidays! ‚ú®</h1>
    <p>Wishing you and your families a Merry Christmas, Happy Holidays, and warm wishes to everyone, whatever you celebrate.</p>
    <p class="healthy-new-year">Here's to a healthy and Happy New Year!</p>
    <p class="subtext">Looking forward to what we'll accomplish together in the year ahead ‚Äî<span class="moon-line">to the moon in 2026! üöÄ</span></p>
  </div>

  <div class="bottom-section">
    <div class="diageo-logo" onclick="openEspressoRecipe()">DIAGEO</div>
    <div class="signoff">Cheers, <span class="signoff-initials" onclick="openBreadRecipe()">JZ</span></div>
  </div>

  <div class="modal-overlay" id="espressoModal" onclick="closeEspressoModal(event)" role="dialog" aria-modal="true" aria-label="Espresso martini recipe">
    <div class="modal" onclick="event.stopPropagation()">
      <span class="modal-close" onclick="closeEspressoModal()" aria-label="Close">&times;</span>

      <div class="martini-wrap" aria-hidden="true">
        <svg class="martini-svg" viewBox="0 0 200 220">
          <path class="glass"
            d="M30 30 L100 105 L170 30
               M100 105 L100 175
               M75 175 L125 175
               M65 190 L135 190"
            fill="none" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>

          <defs>
            <clipPath id="bowlClip">
              <path d="M40 35 L100 98 L160 35 Z"/>
            </clipPath>

            <linearGradient id="choco" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0" stop-color="#6b3f2a"/>
              <stop offset="1" stop-color="#2f1b13"/>
            </linearGradient>

            <linearGradient id="shine" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0" stop-color="rgba(255,255,255,0.65)"/>
              <stop offset="1" stop-color="rgba(255,255,255,0)"/>
            </linearGradient>
          </defs>

          <g clip-path="url(#bowlClip)">
            <path class="liquid" d="M45 45 L100 96 L155 45 Z" fill="url(#choco)"/>
            <path class="foam" d="M46 46 C70 54, 85 50, 100 60 C115 70, 135 58, 154 48 L154 45 L46 45 Z"/>
            <path class="highlight" d="M58 44 L92 78" fill="none" stroke="url(#shine)" stroke-width="8" stroke-linecap="round" opacity="0.55"/>
          </g>

          <circle class="dust" cx="95" cy="58" r="2"/>
          <circle class="dust" cx="110" cy="65" r="1.8"/>
          <circle class="dust" cx="85" cy="70" r="1.6"/>
        </svg>
      </div>

      <h2>Santa's Favorite Espresso Martini</h2>

      <h3>Ingredients</h3>
      <ul>
        <li>1 oz Ketel One Vodka</li>
        <li>0.75 oz Mr. Black Coffee Liqueur</li>
        <li>0.5 oz Baileys Irish Cream (or to taste)</li>
        <li>1 oz Fresh Espresso</li>
        <li>Ice &amp; Garnish: Shake with ice, strain, garnish with beans</li>
      </ul>

      <h3>Instructions</h3>
      <ol>
        <li><strong>Chill Glass:</strong> Chill a martini or coupe glass</li>
        <li><strong>Combine:</strong> Add all ingredients to a cocktail shaker with ice</li>
        <li><strong>Shake Vigorously:</strong> Shake hard for about 15-20 seconds to create a rich foam</li>
        <li><strong>Strain &amp; Garnish:</strong> Strain into the chilled glass and top with three coffee beans</li>
      </ol>
    </div>
  </div>

  <div class="modal-overlay" id="breadModal" onclick="closeBreadModal(event)" role="dialog" aria-modal="true" aria-label="Bread recipe">
    <div class="modal" onclick="event.stopPropagation()">
      <span class="modal-close" onclick="closeBreadModal()" aria-label="Close">&times;</span>
      <div class="drink-emoji" style="text-align:center;font-size:3rem;margin-bottom:1rem;">üçûü•ñ</div>
      <h2>Sullivan Street No-Knead Bread</h2>
      <p style="text-align: center; opacity: 0.8; font-size: 0.9rem; margin-bottom: 0.5rem;">Jim Lahey's Famous Recipe</p>

      <h3>Ingredients</h3>
      <ul>
        <li>3 cups bread flour (or all-purpose)</li>
        <li>1¬Ω teaspoons salt</li>
        <li>¬º teaspoon instant yeast</li>
        <li>1‚Öì cups water (room temperature)</li>
      </ul>

      <h3>Equipment</h3>
      <ul>
        <li>Large bowl</li>
        <li>Plastic wrap</li>
        <li>Dutch oven with lid (cast iron, ceramic, or Pyrex)</li>
        <li>Cotton kitchen towel</li>
      </ul>

      <h3>Instructions</h3>
      <ol>
        <li><strong>Mix (5 min):</strong> Combine flour, salt, and yeast in a large bowl. Add water and stir until a shaggy, sticky dough forms. Cover with plastic wrap.</li>
        <li><strong>First Rise (12-18 hours):</strong> Let rest at room temperature. Dough is ready when the surface is dotted with bubbles and it has more than doubled.</li>
        <li><strong>Shape (2 min):</strong> Flour a work surface generously. Turn out dough and fold it over on itself a few times. Shape into a ball. Cover loosely and let rest 15 minutes.</li>
        <li><strong>Second Rise (1-2 hours):</strong> Place dough seam-side down on a well-floured cotton towel. Dust top with flour, cover with another towel. Let rise until doubled and doesn't spring back when poked.</li>
        <li><strong>Preheat:</strong> 30 minutes before baking, place Dutch oven (with lid) in oven. Heat to 450¬∞F (230¬∞C).</li>
        <li><strong>Bake:</strong> Carefully turn dough into hot pot (seam-side up is fine). Cover and bake 30 minutes. Remove lid and bake another 15-20 minutes until deep golden brown.</li>
        <li><strong>Cool:</strong> Turn out onto a rack. Let cool at least 30 minutes before slicing.</li>
      </ol>

      <div class="tip">
        üí° <strong>Pro tip:</strong> Start the dough the night before Christmas Eve, and you'll have fresh bread ready for Christmas dinner!
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Audio: Fixed & Louder Jingle Bells
     ***********************/
    let audioCtx = null;
    let isPlaying = false;
    let schedulerTimer = null;
    let noiseBuffer = null;

    let masterGain = null;
    let compressor = null;

    const musicBtn = document.getElementById('musicToggle');
    const audioHint = document.getElementById('audioHint');
    const audioUnlock = document.getElementById('audioUnlock');
    const audioUnlockBtn = document.getElementById('audioUnlockBtn');

    // Standard frequencies
    const notes = {
      C4: 261.63, D4: 293.66, E4: 329.63, F4: 349.23, G4: 392.00, A4: 440.00, B4: 493.88,
      C5: 523.25, D5: 587.33, E5: 659.25, F5: 698.46, G5: 783.99
    };

    // Full chorus sequence
    const jingleBells = [
      // Jingle bells, jingle bells, jingle all the way
      { n:'E4', b:1 }, { n:'E4', b:1 }, { n:'E4', b:2 },
      { n:'E4', b:1 }, { n:'E4', b:1 }, { n:'E4', b:2 },
      { n:'E4', b:1 }, { n:'G4', b:1 }, { n:'C4', b:1.5 }, { n:'D4', b:0.5 }, { n:'E4', b:4 },
      // Oh what fun it is to ride in a one horse open sleigh
      { n:'F4', b:1 }, { n:'F4', b:1 }, { n:'F4', b:1.5 }, { n:'F4', b:0.5 },
      { n:'F4', b:1 }, { n:'E4', b:1 }, { n:'E4', b:1 }, { n:'E4', b:0.5 }, { n:'E4', b:0.5 },
      { n:'E4', b:1 }, { n:'D4', b:1 }, { n:'D4', b:1 }, { n:'E4', b:1 }, { n:'D4', b:2 }, { n:'G4', b:2 },
      // Jingle bells, jingle bells, jingle all the way
      { n:'E4', b:1 }, { n:'E4', b:1 }, { n:'E4', b:2 },
      { n:'E4', b:1 }, { n:'E4', b:1 }, { n:'E4', b:2 },
      { n:'E4', b:1 }, { n:'G4', b:1 }, { n:'C4', b:1.5 }, { n:'D4', b:0.5 }, { n:'E4', b:4 },
      // Oh what fun it is to ride in a one horse open sleigh (ending on C)
      { n:'F4', b:1 }, { n:'F4', b:1 }, { n:'F4', b:1.5 }, { n:'F4', b:0.5 },
      { n:'F4', b:1 }, { n:'E4', b:1 }, { n:'E4', b:1 }, { n:'E4', b:0.5 }, { n:'E4', b:0.5 },
      { n:'G4', b:1 }, { n:'G4', b:1 }, { n:'F4', b:1 }, { n:'D4', b:1 }, { n:'C4', b:4 },
      { n:null, b:2 } // Pause before loop
    ];

    const BPM = 120;
    const secondsPerBeat = 60 / BPM;
    const lookaheadMs = 25;
    const scheduleAheadSeconds = 0.1;

    let sequenceIndex = 0;
    let nextNoteTime = 0;

    function ensureAudioGraph() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      // Create noise buffer once to save CPU
      if (!noiseBuffer) {
        const bufferSize = audioCtx.sampleRate * 0.1; // 0.1 sec buffer
        noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = noiseBuffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
          data[i] = Math.random() * 2 - 1;
        }
      }

      if (!compressor) {
        compressor = audioCtx.createDynamicsCompressor();
        compressor.threshold.setValueAtTime(-20, audioCtx.currentTime);
        compressor.ratio.setValueAtTime(8, audioCtx.currentTime);
        compressor.connect(audioCtx.destination);
      }

      if (!masterGain) {
        masterGain = audioCtx.createGain();
        masterGain.gain.setValueAtTime(0.6, audioCtx.currentTime); // Master volume
        masterGain.connect(compressor);
      }
    }

    async function resumeAudio() {
      ensureAudioGraph();
      if (audioCtx.state === 'suspended') {
        await audioCtx.resume();
      }
    }

    // A louder, simpler bell synthesis
    function createBell(freq, t, durSec) {
      if (!audioCtx || !masterGain) return;

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      // Triangle wave cuts through better on mobile speakers than sine
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(freq, t);

      // Simple decay envelope
      gain.gain.setValueAtTime(0, t);
      gain.gain.linearRampToValueAtTime(0.8, t + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.01, t + durSec);

      osc.connect(gain);
      gain.connect(masterGain);

      osc.start(t);
      osc.stop(t + durSec + 0.1);

      // Add a tiny bit of high-pitch "sparkle" (sine overtone)
      const osc2 = audioCtx.createOscillator();
      const gain2 = audioCtx.createGain();
      osc2.type = 'sine';
      osc2.frequency.setValueAtTime(freq * 2, t);
      gain2.gain.setValueAtTime(0, t);
      gain2.gain.linearRampToValueAtTime(0.3, t + 0.02);
      gain2.gain.exponentialRampToValueAtTime(0.01, t + (durSec * 0.8));

      osc2.connect(gain2);
      gain2.connect(masterGain);
      osc2.start(t);
      osc2.stop(t + durSec + 0.1);
    }

    function scheduleNote(noteName, time, beatLength) {
      if (!noteName) return;
      const freq = notes[noteName];
      if (!freq) return;

      // Note duration
      const durSec = beatLength * secondsPerBeat * 0.85;
      createBell(freq, time, durSec);
    }

    function nextEvent() {
      const evt = jingleBells[sequenceIndex];
      scheduleNote(evt.n, nextNoteTime, evt.b);
      nextNoteTime += evt.b * secondsPerBeat;
      sequenceIndex = (sequenceIndex + 1) % jingleBells.length;
    }

    function scheduler() {
      if (!isPlaying || !audioCtx) return;
      // Schedule notes that fall within the lookahead window
      while (nextNoteTime < audioCtx.currentTime + scheduleAheadSeconds) {
        nextEvent();
      }
      schedulerTimer = setTimeout(scheduler, lookaheadMs);
    }

    async function startMusic() {
      await resumeAudio();
      sequenceIndex = 0;
      nextNoteTime = audioCtx.currentTime + 0.1; // Start slightly in future
      if (schedulerTimer) clearTimeout(schedulerTimer);
      scheduler();
    }

    function stopMusic() {
      if (schedulerTimer) clearTimeout(schedulerTimer);
      schedulerTimer = null;
    }

    // Unlock gating variables
    let audioUnlockedOnce = false;

    async function unlockAudioFromGesture() {
      try {
        ensureAudioGraph();
        await audioCtx.resume();
        
        // Play a silent buffer to force the audio engine to wake up (iOS hack)
        const buffer = audioCtx.createBuffer(1, 1, 22050);
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start(0);

        audioUnlockedOnce = true;
        audioUnlock.classList.remove('show');
        audioHint.classList.remove('show');
        return true;
      } catch (e) {
        console.warn('Unlock failed:', e);
        audioHint.classList.add('show');
        setTimeout(() => audioHint.classList.remove('show'), 6500);
        return false;
      }
    }

    // Button in the overlay
    audioUnlockBtn.addEventListener('click', async () => {
      const ok = await unlockAudioFromGesture();
      if (ok) {
        isPlaying = true;
        musicBtn.textContent = 'üîä';
        musicBtn.classList.add('playing');
        await startMusic();
      }
    });

    // Main Toggle Button
    async function toggleMusic() {
      if (!audioUnlockedOnce) {
        // If never unlocked, force the overlay
        audioUnlock.classList.add('show');
        return;
      }

      if (isPlaying) {
        isPlaying = false;
        stopMusic();
        musicBtn.textContent = 'üîá';
        musicBtn.classList.remove('playing');
      } else {
        isPlaying = true;
        musicBtn.textContent = 'üîä';
        musicBtn.classList.add('playing');
        try {
          await startMusic();
        } catch (e) {
          console.log("Error starting music", e);
        }
      }
    }

    // Attempt silent unlock on first interaction (improves desktop experience)
    const tryUnlockOnce = async () => {
      if (audioUnlockedOnce) return;
      // Just init context, don't start music yet
      ensureAudioGraph();
      if (audioCtx.state === 'suspended') {
        audioCtx.resume().then(() => {
          audioUnlockedOnce = true;
          // Hide overlay if it was auto-shown
          audioUnlock.classList.remove('show'); 
        }).catch(() => {});
      }
    };
    document.addEventListener('click', tryUnlockOnce, { once: true });
    document.addEventListener('touchstart', tryUnlockOnce, { once: true });

    // Show overlay immediately on mobile devices (best iOS experience)
    const isLikelyMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (isLikelyMobile) {
      audioUnlock.classList.add('show');
    }

    /***********************
     * Stars + Snow
     ***********************/
    const starCount = (window.innerWidth < 500) ? 45 : 80;
    const flakeCount = (window.innerWidth < 500) ? 28 : 50;

    for (let i = 0; i < starCount; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      const size = Math.random() * 3 + 1;
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = Math.random() * 100 + 'vw';
      star.style.top = Math.random() * 50 + 'vh';
      star.style.animationDuration = (1.5 + Math.random() * 2) + 's';
      star.style.animationDelay = Math.random() * 3 + 's';
      document.body.appendChild(star);
    }

    for (let i = 0; i < flakeCount; i++) {
      const flake = document.createElement('div');
      flake.className = 'snowflake';
      flake.textContent = ['‚ùÑ', '‚ùÖ', '‚ùÜ'][Math.floor(Math.random() * 3)];
      flake.style.left = Math.random() * 100 + 'vw';
      flake.style.animationDuration = (3 + Math.random() * 4) + 's';
      flake.style.animationDelay = Math.random() * 5 + 's';
      flake.style.fontSize = (0.8 + Math.random()) + 'rem';
      document.body.appendChild(flake);
    }

    /***********************
     * Modals
     ***********************/
    function openEspressoRecipe() { document.getElementById('espressoModal').classList.add('active'); }
    function closeEspressoModal(event) {
      if (!event || event.target === document.getElementById('espressoModal') || event.target.classList.contains('modal-close')) {
        document.getElementById('espressoModal').classList.remove('active');
      }
    }
    function openBreadRecipe() { document.getElementById('breadModal').classList.add('active'); }
    function closeBreadModal(event) {
      if (!event || event.target === document.getElementById('breadModal') || event.target.classList.contains('modal-close')) {
        document.getElementById('breadModal').classList.remove('active');
      }
    }
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') { 
        document.getElementById('espressoModal').classList.remove('active');
        document.getElementById('breadModal').classList.remove('active');
      }
    });

    /***********************
     * Live BTC Price
     ***********************/
    async function fetchPrice() {
      const apis = [
        { url: 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd', parse: (d) => d.bitcoin.usd },
        { url: 'https://api.coinbase.com/v2/prices/BTC-USD/spot', parse: (d) => parseFloat(d.data.amount) },
        { url: 'https://api.coindesk.com/v1/bpi/currentprice.json', parse: (d) => parseFloat(d.bpi.USD.rate.replace(',', '')) }
      ];

      for (const api of apis) {
        try {
          const res = await fetch(api.url, { cache: 'no-store' });
          const data = await res.json();
          const price = api.parse(data);
          if (price) {
            document.getElementById('price').textContent =
              '$' + price.toLocaleString('en-US', { maximumFractionDigits: 0 });
            return;
          }
        } catch (e) {}
      }
    }
    fetchPrice();
    setInterval(fetchPrice, 30000);
  </script>
</body>
</html>


